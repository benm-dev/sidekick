import{a as Wt}from"../../../chunk-J7WSXT32.js";import{a as Ct,d as Et,e as qt,f as Yt,k as Zt,l as ne,m as X,n as Bt,o as Dt,p as pe,q as he,r as ge,s as be}from"../../../chunk-JGEHADN5.js";import{a as Xt}from"../../../chunk-5JS46TXG.js";import"../../../chunk-RBMHFGWD.js";import{H,L as ae,N as $,O as ce,P as de,Q as Z,R as ue,S as me,T as ye,a as Vt,da as E}from"../../../chunk-I3ILDBO5.js";import{a as le}from"../../../chunk-Q3TMK7K4.js";import"../../../chunk-3ZYQDD7H.js";import{G as w,H as Jt,I as te,J as R,K as ee,L as re,N as st,Q as nt,R as O,S as ie,T as at,W as oe,Y as V,Z as se,a as it,aa as F,b as z,ea as fe,k as Lt,l as ot,n as Nt,o as Qt,q as zt,s as $t,t as C,v as q,w as Y,y as Kt,z as Gt}from"../../../chunk-OBPWZYQZ.js";import{a as D,m as jt}from"../../../chunk-QGLCH3FC.js";import{f as l,i as v,j as Ft,l as h}from"../../../chunk-LGMSABOQ.js";l();l();var Se=it,Ie=new Promise(o=>{Se=o}),He=({applicationsApi:o,bookmarksApi:t,documentsApi:e,historyApi:r,openedTabsApi:i,searchApi:s,statisticApi:n,searchConfig:a})=>Ct({actions:{addBookmark:t.addBookmark.bind(t),addOpenedTab:i.addOpenedTab.bind(i),cancelSearch:s.cancelSearch.bind(s),clearAllApps:o.clearAllApps.bind(o),clearAllHistory:r.clearAllHistory.bind(r),clearUnusedPartitionForAccount:r.clearUnusedPartitionForAccount.bind(r),clearUnusedPartitionForWorkspace:r.clearUnusedPartitionForWorkspace.bind(r),optimizeHistory:r.optimize.bind(r),removeAppById:o.removeAppById.bind(o),removeBookmark:t.removeBookmark.bind(t),removeOpenedTab:i.removeOpenedTab.bind(i),removeUrlsFromHistory:r.removeUrlsFromHistory.bind(r),saveBatchToIDBStore:r.saveBatchToIDBStore.bind(r),selectSearchItem:n.selectSearchItem.bind(n),setConfig:a.update.bind(a),setModelForHistory:r.setModelForHistory.bind(r),setNavigationScripts:e.setNavigationScripts.bind(e),setRequestVisitsHandler:r.setRequestVisitsHandler.bind(r),stopHistory:r.stopHistory.bind(r),updateBookmark:t.updateBookmark.bind(t),updateOpenedTab:i.updateOpenedTab.bind(i),upsertApp:o.upsertApp.bind(o),upsertToHistory:r.upsertToHistory.bind(r)},queries:{getDomainsStatistic:n.getDomainsStatistic.bind(n),getTitleFromUrl:r.getTitleFromUrl.bind(r),getTotalHistoryCount:r.getTotalHistoryCount.bind(r),getUrlStatistic:n.getUrlStatistic.bind(n),initBookmarks:t.initBookmarks.bind(t),initHistory:r.initHistory.bind(r),initOpenedTabs:i.initOpenedTabs.bind(i),search:s.search.bind(s)},stores:{}}),ve=o=>{let t=He(o);return Se(t),t};l();l();var ct=class{source;constructor(t){this.source=t.source}upsertApp(t){this.source.upsert(t)}removeAppById(t){this.source.remove(t)}clearAllApps(){this.source.clear()}};l();l();l();var xe=o=>o==null;var S=o=>Boolean(v(o,"hostname")&&o.hostname&&!xe(o.partitionId));l();var Fe=Object.freeze([]),je=()=>{let o=new Map,t=setInterval(()=>{o.clear()},1e4);return{index:o,dispose:()=>clearInterval(t)}},{index:Ot}=je(),We=o=>(Ot.has(o)||Ot.set(o,o),Ot.get(o)||o),Ce=o=>We(o.toLocaleLowerCase()),_=o=>{if(!o)return{original:o,words:Fe};let t=o.split(/[\s!@#$%^&*()\-+_=;:'"`~<>,/.[\]|\\?]/g),e=[];for(let r=0;r<t.length;r+=1){let i=t[r];i&&e.push(Ce(i))}return{original:o,words:e}};l();var j=class{*internalSearch(t,e,r,i,s){let n=[];for(let a of t)if(a.shouldShowInSearch(e)){if(s){let c=a.match(s,r);c.length&&n.push({record:a,match:c})}else n.push({record:a});n.length>0&&n.length%i===0&&(yield n,n=[])}n.length&&(yield n)}};l();l();var A=o=>o[o.length-1]??null;l();var L=o=>o.startsWith(ae.newtab);l();l();l();var M=(o,t)=>{let e=0;for(let r=0;r<o.length;r+=1){let i=o[r];h(i!==void 0,`Item of list must be type of number, but item with index ${r} is undefined`),i>=t&&(e+=1)}return e};var Ve=30,Ee=Qt(C(1)),J=o=>Math.log(1+o),Re=o=>Math.log(1/(.5+o)),Te=(o,t,e,r,i,s,n,a,c,p,u,m)=>{let f={score:0,scoreDebug:""},y=(b,U)=>{let I=Math.floor(U);f.score=(f.score||0)+I,r&&(f.scoreDebug+=` ${b}:${I}`)};if(y("b",o.base),t?.text){let b=_(t.text).words.length;y("qw",b*o.queryWordsCountRatio)}let T=0;s!==null&&v(o,"titleMatchRatio")&&(T+=(s*o.titleMatchRatio)**2),v(o,"appNameMatchRatio")&&(T+=(n*o.appNameMatchRatio)**2),a!==null&&v(o,"workspaceNameMatchRatio")&&(T+=(a*o.workspaceNameMatchRatio)**2),c!==null&&v(o,"itemTypeMatchRatio")&&(T+=(c*o.itemTypeMatchRatio)**2),p!==null&&v(o,"urlMatchRatio")&&(T+=(p*o.urlMatchRatio)**2),y("ms",Math.sqrt(T)),y("ss",J(u)*o.selectRatio),v(o,"activeBonus")&&y("ab",i?o.activeBonus:0);let B=(m&&A(m))??null;if(v(o,"lastAccessDaysRatio")){let b=Re(B&&Kt(B,e)||Ve);y("la",b*o.lastAccessDaysRatio)}if(v(o,"lastAccessMinutesRatio")){let b=Re(B&&Gt(B,e)||Ee);y("la",b*o.lastAccessMinutesRatio)}if(m!==null&&o.visitsCountRatio!==null){if(o.visitsCountRatio.today!==0){let b=J(M(m,e-C(1)));y("ct",b*o.visitsCountRatio.today)}if(o.visitsCountRatio.lastWeek!==0){let b=J(M(m,e-q(1)));y("cw",b*o.visitsCountRatio.lastWeek)}if(o.visitsCountRatio.lastMonth!==0){let b=J(M(m,e-Y(1)));y("cm",b*o.visitsCountRatio.lastMonth)}if(o.visitsCountRatio.all!==0){let b=J(m.length);y("ca",b*o.visitsCountRatio.all)}}return r&&(f.scoreDebug=`Score: ${f.score} =${f.scoreDebug}`),f};var W=(o,t,e,r,i,s,n,a,c,p,u,m,f)=>(Object.assign(o,Te(t,e,r,i,s,n,a,c,p,u,m,f)),o),g=(o,t)=>{if(!o)return 0;let e=0;for(let r=0;r<o.length;r+=1){let i=o[r];h(i!==void 0,"Failed to get match score: item is undefined"),i.field===t&&i.score>e&&(e=i.score)}return e};l();l();var Ut=[],ke=[];function lt(o,t){if(o===t)return 0;let e=o;o.length>t.length&&(o=t,t=e);let r=o.length,i=t.length;for(;r>0&&o.charCodeAt(~-r)===t.charCodeAt(~-i);)r--,i--;let s=0;for(;s<r&&o.charCodeAt(s)===t.charCodeAt(s);)s++;if(r-=s,i-=s,r===0)return i;let n,a,c,p,u=0,m=0;for(;u<r;)ke[u]=o.charCodeAt(s+u),Ut[u]=++u;for(;m<i;)for(n=t.charCodeAt(s+m),c=m++,a=m,u=0;u<r;u++)p=n===ke[u]?c:c+1,c=Ut[u],a=Ut[u]=c>a?p>a?a+1:p:p>c?c+1:p;return a}var Le=Object.freeze([]),we=(o,t,e)=>{let{exactBonus:r=0,startIncludeBonus:i=0,includeBonus:s=0,uselessBonus:n=0,startFuzzyBonus:a=0,fuzzyBonus:c=0,distancePenalty:p=0,usefulLimitDistance:u=0}=e;if(t===o)return r;let m=p||u?lt(o,t):0,f=m*p;return i&&t.startsWith(o)?f+i:o.length<3?f+n:s&&t.includes(o)?f+s:a&&u&&o.length<t.length&&lt(t.slice(0,o.length),o)<=u?f+a:c&&u&&m<=u?f+c:f+n},x=class{data;constructor(t){this.data=Object.entries(t).map(([e,r])=>({field:e,preparedText:_(r)}))}match(t,e){let r=[];for(let s=0;s<t.words.length;s+=1){let n=t.words[s];h(n!==void 0,"Failed to get text search match: queryWord is undefined",{query:t,index:s});let a=!1;for(let c=0;c<this.data.length;c+=1){let p=this.data[c];h(p!==void 0,"Failed to get text search match: fieldInfo is undefined",{data:this.data,index:c});let{field:u,preparedText:m}=p,f={field:u,score:0,query:n,word:""};for(let y=0;y<m.words.length;y+=1){let T=m.words[y];h(T!==void 0,"Failed to get text search match: word is undefined",{preparedText:m,index:y});let B=we(n,T,e);B>f.score&&(f.word=T,f.score=B)}f.score>0&&(r.push(f),a=!0)}if(!a)return Le}let i=this.data.find(s=>s.field==="url");if(i){let{field:s,preparedText:n}=i,a={field:s,score:0,query:t.original,word:""},c=[n.original,st(te(n.original))];for(let p=0;p<c.length;p+=1){let u=c[p];h(u!==void 0,"Failed to get text search match: fullStr is undefined",{fullStrings:c,index:p});let m=we(t.original,u,e);m>a.score&&(a.word=u,a.score=e.exactUrlBonus*m)}a.score>0&&r.push(a)}return r}};var K=class{url="";partitionId="";title="";id;hostname="";openedTabId=null;favIconUrl="";workspaceId;isRunning=!1;visits=[];idToUse="";textSearch=new x({});constructor(t){let{id:e,workspaceId:r}=t;this.id=e,this.workspaceId=r,this.update(t)}update({partitionId:t,title:e,url:r,hostname:i,openedTabId:s,favIconUrl:n,isRunning:a,workspaceId:c,visits:p}){return this.partitionId=t,this.title=e,this.url=w(R(r))??r,this.hostname=i||"",this.openedTabId=s??null,this.favIconUrl=n,this.isRunning=a,this.workspaceId=c,this.visits=p??[],this.compute(),this}getPolishedDocument(){return null}setPolishedDocument(){}calcScore(t,{rules:e,query:r,selectStatistic:i,now:s}){let{match:n}=t,a=e.app;return W(t,a,r,s,e.debug,this.isRunning,null,g(n,"title"),g(n,"workspaceName"),null,null,i.get(this.idToUse),this.visits)}export(t){let{navigationScriptsManager:e}=t??{};return{type:"service",id:this.idToUse,title:this.title||this.url,serviceId:this.id,tabId:this.openedTabId,url:V(this.url),partitionId:this.partitionId,hostname:this.hostname,favIconUrl:e?.getFavIconForHostname(this.hostname)||this.favIconUrl,itemType:"Application",lastVisitTime:A(this.visits)??0}}shouldShowInSearch(t){return S(t)||L(this.url)?!1:t.workspaceId===void 0||this.workspaceId===t.workspaceId}match(t,e){return this.textSearch.match(t,e)}compute(){this.idToUse=`service-${this.id}`,this.textSearch=new x({title:this.title})}};var pt=class extends j{indexById=new Map;*search(t,e,r=100,i=t.text?_(t.text):null){if(S(t))return;let s=this.indexById.values();yield*this.internalSearch(s,t,e,r,i)}upsert(t){let e=this.indexById.get(t.id);if(e){e.update(t);return}this.indexById.set(t.id,new K(t))}clear(){this.indexById.clear()}remove(t){this.indexById.delete(t)}};l();var dt=class{source;constructor(t){this.source=t.source}initBookmarks(t){this.source.init(t)}addBookmark(t){t.url&&this.source.add(t)}updateBookmark(t,e){this.source.update({url:"",...e,id:t})}removeBookmark(t){this.source.remove(t)}};l();l();var ut=class{url;partitionId="";title="";hostname="";id;idToUse="";polishedDocument=null;textSearch=new x({});constructor({id:t,title:e,url:r}){this.id=t,this.title=e,this.url=w(R(r))??r,this.compute()}getRecordInHistory(t,e){return t.getRecord(this.url,e,this.hostname)}update({title:t,url:e}){return this.title=t,this.url=w(R(e))??e,this.compute(),this}getPolishedDocument(){return this.polishedDocument}setPolishedDocument(t){this.polishedDocument=t,this.compute()}calcScore(t,{rules:e,sources:r,query:i,selectStatistic:s,now:n}){let{match:a}=t,c=e.bookmark,p=this.getRecordInHistory(r.history,i.partitionId||"");return W(t,c,i,n,e.debug,!1,g(a,"title"),g(a,"appName"),null,g(a,"itemType"),g(a,"url"),s.get(this.idToUse),p?.visits||null)}export(t){let{query:e,sources:r,navigationScriptsManager:i}=t??{},s=e?.partitionId??"",n=r?this.getRecordInHistory(r.history,s):null,a=n?.export();return{type:"bookmark",id:this.idToUse,title:this.title||this.url,url:V(this.url),partitionId:s,hostname:this.hostname,favIconUrl:i?.getFavIconForHostname(this.hostname)||a?.favIconUrl||F(this.url)||null,lastVisitTime:(n&&A(n.visits))??0,itemType:"Bookmark"}}shouldShowInSearch(t){return!L(this.url)}match(t,e){return this.textSearch.match(t,e)}compute(){this.hostname=O(this.url)||"",this.idToUse=`bookmark-${this.id}`,this.textSearch=new x({title:this.title,itemType:"Bookmark",appName:this.polishedDocument?.recipeAppName??"",url:this.url})}};var ht=class extends j{indexById=new Map;indexByHostname=new Map;linker;constructor({linker:t}){super(),this.linker=t,this.linker.onReload(()=>this.onLinkerReload())}init(t){this.clear(),t.forEach(e=>this.add(e))}*search(t,e,r=100,i=t.text?_(t.text):null){let n=(S(t)?this.indexByHostname.get(t.hostname)??new Set:this.indexById).values();yield*this.internalSearch(n,t,e,r,i)}add({id:t,title:e,url:r}){let i=new ut({id:t,title:e,url:r});this.linker.link(i),this.indexById.set(t,i),this.addItemToIndexByHostname(i)}update({id:t,title:e,url:r}){let i=this.indexById.get(t);if(i===void 0)return!1;let s=i.hostname;if(i.update({id:t,title:e,url:r}),this.linker.link(i),s!==i.hostname){let n=this.indexByHostname.get(s);h(n,"Couldn't find set by hostname"),n.delete(i),this.addItemToIndexByHostname(i)}return!0}clear(){this.indexById.clear(),this.indexByHostname.clear()}remove(t){let e=this.indexById.get(t);if(e===void 0)return!1;this.indexById.delete(t);let r=this.indexByHostname.get(e.hostname);return h(r,"Couldn't find set by hostname"),r.delete(e),!0}onLinkerReload(){Array.from(this.indexById.values()).forEach(t=>this.linker.link(t))}addItemToIndexByHostname(t){let{hostname:e}=t,r=this.indexByHostname.get(e);r||(r=new Set,this.indexByHostname.set(e,r)),r.add(t)}};l();var mt=class{navigationScriptsManager;navigationScriptsManagerReady=new X;constructor(t){this.navigationScriptsManager=t.navigationScriptsManager}setNavigationScripts(t){this.navigationScriptsManagerReady.mark(!1),this.navigationScriptsManager.setNavigationScripts(t),this.navigationScriptsManagerReady.mark(!0)}};l();l();l();var N=class{url;partitionId;accountId="";title="";hostname="";domain=null;excluded=null;visits=[];favIconUrl="";contentCrawledAt=null;contentTitle="";contentFavIconUrl="";attentionSpans=[];markedAsUselessAt=null;titleToUse="";id="";isMessenger=!1;polishedDocument=null;textSearch=new x({});idbKeys=new Set;constructor(t){let{url:e,partitionId:r="",accountId:i=""}=t;this.url=(ee(e)||re(e)?e:w(R(e)))??e,this.partitionId=r,this.accountId=i,this.update(t)}update(t){let{title:e,favIconUrl:r,visits:i,attentionSpans:s,contentCrawledAt:n,contentTitle:a,contentFavIconUrl:c,markedAsUselessAt:p}=Yt(t,this.getAsRawRecord());return this.title=e??"",this.favIconUrl=r??"",this.visits=i,this.attentionSpans=s,this.contentCrawledAt=n,this.contentTitle=a??"",this.contentFavIconUrl=c??"",this.markedAsUselessAt=p,this.compute(),this}getPolishedDocument(){return this.polishedDocument}setPolishedDocument(t){this.polishedDocument=t,this.compute()}get hasPolishedData(){return Boolean(this.polishedDocument)}calcScore(t,e){if(this.polishedDocument)return this.polishedDocument.calcScore(t,e);let{match:r}=t,{rules:i,query:s,selectStatistic:n,now:a}=e;return W(t,i.other,s,a,i.debug,!1,g(r,"title"),g(r,"appName"),null,g(r,"itemType"),g(r,"url"),n.get(this.id),this.visits)}getIdForStatistic(){return this.id}getUpdatedAt(){return A(this.polishedDocument?.visits??this.visits)||this.contentCrawledAt||0}getDataForStatistic(){return{visits:this.polishedDocument?.visits??this.visits,attentionSpans:this.polishedDocument?.attentionSpans??this.attentionSpans}}getAsRawRecord(){return{url:this.url,partitionId:this.partitionId,accountId:this.accountId,title:this.title,favIconUrl:this.favIconUrl,visits:this.visits,attentionSpans:this.attentionSpans,contentCrawledAt:this.contentCrawledAt,contentTitle:this.contentTitle,contentFavIconUrl:this.contentFavIconUrl,markedAsUselessAt:this.markedAsUselessAt}}export(t){return this.polishedDocument&&!this.polishedDocument.excluded?this.polishedDocument.export(t):{type:"other",id:this.id,title:this.titleToUse||this.url,url:V(this.url),partitionId:this.partitionId,hostname:this.hostname,favIconUrl:t?.navigationScriptsManager.getFavIconForHostname(this.hostname)||this.favIconUrl||this.contentFavIconUrl||F(this.url)||null,lastVisitTime:A(this.visits)??0,itemType:"Web Page"}}shouldShowInSearch(t){return!(S(t)&&(t.onlyPolished&&!this.hasPolishedData||t.onlyVisited&&!this.visits.length)||this.excluded||L(this.url))}match(t,e){return this.polishedDocument?this.polishedDocument.match(t,e):this.textSearch.match(t,e)}isSameByTitleAndDomain(t){return this.domain===t.domain&&this.title===t.title}isUseless(t=Date.now()){return!this.markedAsUselessAt||t-this.markedAsUselessAt>C(7)}addIDBKey(t){this.idbKeys.add(t)}getIDBKeys(){return Array.from(this.idbKeys)}compute(){this.excluded=this.polishedDocument?.excluded??null,!this.excluded&&(this.hostname=O(this.url)??"",this.domain=at(this.url),this.isMessenger=this.polishedDocument?.isMessenger||!1,this.titleToUse=this.contentTitle||this.title,this.id=this.polishedDocument?.id||`${this.partitionId}-${this.url}`,this.textSearch=new x({title:this.titleToUse,itemType:"Web Page",url:this.polishedDocument?.url||this.url}))}};l();var Q=class{url;partitionId;title="";hostname="";id;favIconUrl="";appId;workspaceId;idToUse="";titleToUse=this.title;polishedDocument=null;textSearch=new x({});constructor(t){let{id:e,url:r,partitionId:i="",appId:s,workspaceId:n}=t;this.id=e,this.url=w(R(r))??r,this.partitionId=i,this.appId=s,this.workspaceId=n,this.update(t)}update({title:t,url:e,favIconUrl:r,appId:i,workspaceId:s}){return this.title=t||this.title,this.url=(w(R(e))??e)||this.url,this.favIconUrl=r||this.favIconUrl,this.appId=i,this.workspaceId=s,this.compute(),this}getPolishedDocument(){return this.polishedDocument}setPolishedDocument(t){this.polishedDocument=t,this.compute()}calcScore(t,{rules:e,query:r,sources:i,selectStatistic:s,now:n}){let{match:a}=t,c=e.openedTab,p=i.history.getRecord(this.url,this.partitionId,this.hostname);return W(t,c,r,n,e.debug,!0,g(a,"title"),g(a,"appName"),null,g(a,"itemType"),g(a,"url"),s.get(this.idToUse),p?.visits??null)}export(t){let{sources:e,navigationScriptsManager:r}=t??{},i=e?.history.getRecord(this.url,this.partitionId,this.hostname)?.export();return{type:"tab",id:`tab-${this.id}`,tabId:this.id,title:this.titleToUse||i?.title||this.url,url:V(this.url),partitionId:this.partitionId,hostname:this.hostname,favIconUrl:r?.getFavIconForHostname(this.hostname)||this.favIconUrl||i?.favIconUrl||F(this.url)||null,itemType:"Opened tab",lastVisitTime:i?.lastVisitTime??0}}shouldShowInSearch(t){return this.appId||this.polishedDocument?.excluded||L(this.url)||S(t)?!1:t.workspaceId===void 0||this.workspaceId===t.workspaceId}match(t,e){return this.textSearch.match(t,e)}compute(){this.hostname=O(this.url)||"",this.titleToUse=this.polishedDocument?.title||this.title,this.textSearch=new x({title:this.titleToUse,itemType:"Opened tab",appName:this.polishedDocument?.recipeAppName??"",url:this.url})}};var yt=class{id;title="";partitionId;favIconUrl;visits=[];attentionSpans=[];set=new Set;polishResult;textSearch=new x({});constructor({id:t,partitionId:e,polishResult:r}){this.id=t,this.partitionId=e,this.polishResult=r,this.compute()}add(t){this.set.add(t)}update(t){this.polishResult=t}delete(t){this.set.delete(t)}clear(){this.set.forEach(t=>t.setPolishedDocument(null)),this.set.clear()}compute(){this.computeForStatistic(),this.computeForSearch()}get excluded(){return this.polishResult.excluded}get url(){return h(!this.polishResult.excluded,"Document shouldn't be excluded"),this.polishResult.url}get hostname(){return this.polishResult.hostname}get itemType(){return h(!this.polishResult.excluded,"Document shouldn't be excluded"),this.polishResult.itemType}get recipeAppName(){return this.polishResult.recipeAppName}get openInAppWithRecipeId(){return h(!this.polishResult.excluded,"Document shouldn't be excluded"),this.polishResult.openInAppWithRecipeId}get isMessenger(){return h(!this.polishResult.excluded,"Document shouldn't be excluded"),this.polishResult.isMessenger}calcScore(t,{rules:e,query:r,selectStatistic:i,now:s}){let{match:n}=t;return W(t,e.document,r,s,e.debug,!1,g(n,"title"),g(n,"appName"),null,g(n,"itemType"),g(n,"url"),i.get(this.id),this.visits)}export(t){let e=$(this.visits),r=t?.navigationScriptsManager.getFavIconForHostname(this.hostname)||this.favIconUrl||F(this.url)||null;return{type:"document",id:this.id,title:this.title||this.url,url:this.url,partitionId:this.partitionId,hostname:this.hostname,favIconUrl:r,lastVisitTime:e??0,itemType:this.excluded?"Excluded":this.itemType,openInAppWithRecipeId:this.openInAppWithRecipeId}}match(t,e){return this.excluded?[]:this.textSearch.match(t,e)}computeForSearch(){this.excluded||(this.textSearch=new x({title:this.title,itemType:this.itemType,appName:this.recipeAppName,url:this.url}))}computeForStatistic(){let t=[],e=[];this.set.forEach(r=>{r instanceof N&&(t=[...t,...r.visits],e=[...e,...r.attentionSpans])}),this.visits=qt(t),this.attentionSpans=e,this.title=this.getBestTitle(),this.favIconUrl=this.getBestFaviconUrl()}getBestTitle(){return Array.from(this.set).map(e=>v(e,"contentTitle")&&typeof e.contentTitle=="string"&&e.contentTitle?e.contentTitle:null).find(z)||(this.polishResult.excluded?"":this.polishResult.title)||H(Array.from(this.set),e=>!(e instanceof Q),e=>-(e instanceof N&&A(e.visits)||0))[0]?.title||""}getBestFaviconUrl(){let t=r=>r instanceof K?30:r instanceof Q?20:10;return ce(Array.from(this.set).map(r=>v(r,"favIconUrl")&&typeof r.favIconUrl=="string"&&r.favIconUrl?{priority:t(r),url:r.favIconUrl}:v(r,"contentFavIconUrl")&&typeof r.contentFavIconUrl=="string"&&r.contentFavIconUrl?{priority:t(r),url:r.contentFavIconUrl}:{priority:0}),"priority")?.url||this.polishResult.favIconUrl}};var ft=class{emitter=new Xt;navigationScriptsManager;byIds=new Map;constructor({navigationScriptsManager:t}){this.navigationScriptsManager=t,this.navigationScriptsManager.onNavigationScriptsLoaded(()=>{this.clear(),this.emitter.emit("reload")})}link(t){let e=this.navigationScriptsManager.polishDocument(t);if(!e){let n=t.getPolishedDocument();n&&n.delete(t),t.setPolishedDocument(null);return}let r=e.excluded?`excluded-${t.url}`:e.key,i=`${t.partitionId}~${e.hostname}~${r}`,s=this.getOrCreateDocumentById(i,{polishResult:e,partitionId:t.partitionId});s.add(t),s.update(e),s.compute(),t.setPolishedDocument(s)}clear(){this.byIds.forEach(t=>t.clear()),this.byIds.clear()}onReload(t){return this.emitter.on("reload",t)}hasNavigationScriptFor(t){return this.navigationScriptsManager.hasNavigationScriptFor(t)}getOrCreateDocumentById(t,{polishResult:e,partitionId:r}){let i=this.byIds.get(t);if(i)return i;let s=new yt({id:t,polishResult:e,partitionId:r});return this.byIds.set(t,s),s}};l();var gt=class{source;onRequestVisitsHandler=it;constructor(t){this.source=t.source}async initHistory(t){await this.source.init(t)}stopHistory(){this.source.indexReady.mark(!1)}async getTotalHistoryCount(){return await this.source.indexLoaded.wait(),this.source.getTotalCount()}async setModelForHistory(t){this.source.statistics.setModel(t),await this.source.recalculateScores()}upsertToHistory(t){this.source.upsert(t)}async clearAllHistory(){await this.source.clear()}async saveBatchToIDBStore(){await this.source.saveBatchToIDBStore()}clearUnusedPartitionForWorkspace(t){return this.source.clearUnusedPartitionForWorkspace(t)}clearUnusedPartitionForAccount(t,e){return this.source.clearUnusedPartitionForAccount(t,e)}async removeUrlsFromHistory(t){await this.source.removeByUrlList(t)}setRequestVisitsHandler(t){this.onRequestVisitsHandler=e=>{let r;r=jt(s=>{r.dispose(),this.source.updateVisits(s).catch(D)}),t(e,r)}}getRequestVisitsHandler(){return this.onRequestVisitsHandler}getTitleFromUrl(t){return this.source.getTitleFromUrl(t)}optimize(){return this.source.optimize()}};l();l();var tt=(o,t)=>{if(o.length===0)return 0;let e=a=>o[a]||0;if(t<=0)return e(0);if(t>=1)return e(o.length-1);let r=(o.length-1)*t,i=Math.floor(r),s=i+1;if(s>=o.length)return e(i);let n=r%1;return e(i)*(1-n)+e(s)*n};l();var bt=class{list=new Set;index=new Map;mergeFn;onAfterUpdate;updatePromise=null;constructor({mergeFn:t,onAfterUpdate:e}){this.mergeFn=t,this.onAfterUpdate=e}get(t,e,r,i){let s=this.index.get(i||O(t)||"");if(s===void 0)return null;let n=s.map.get(e);if(n===void 0)return null;let a=n.map.get(r);if(a===void 0)return null;let c=a.map.get(t);return c===void 0?null:c}set(t){let{partitionId:e,url:r,accountId:i}=t,s=t.hostname||O(r)||"",n=this.index.get(s);n===void 0&&(n={protocol:Jt(r)??null,domain:at(r),map:new Map,list:new Set},this.index.set(s,n));let a=n.map.get(e);a===void 0&&(a={map:new Map,list:new Set},n.map.set(e,a));let c=a.map.get(i);return c===void 0&&(c={map:new Map,list:new Set},a.map.set(i,c)),c.map.set(r,t),c.list.add(t),a.list.add(t),n.list.add(t),this.list.add(t),this.scheduleUpdate(),t}upsert(t){let e=this.get(t.url,t.partitionId,t.accountId,t.hostname),r=this.mergeFn(t,e);return this.set(r)}clear(){this.index.clear(),this.list.clear(),this.scheduleUpdate()}remove(t){this.list.delete(t);let e=this.index.get(t.hostname||O(t.url)||"");if(e===void 0)return;let r=e.map.get(t.partitionId);if(e.map.delete(t.partitionId),e.list.delete(t),r===void 0)return;let i=r.map.get(t.accountId);r.map.delete(t.accountId),r.list.delete(t),i!==void 0&&(i.map.delete(t.url),i.list.delete(t))}removeByUrlList(t){let e=[];return this.list.forEach(r=>{t.includes(r.url)&&(this.remove(r),e.push(r))}),e}clearUnusedPartitionForWorkspace(t){let e=new Set;for(let r of this.index.values())this.clearPartition(e,r,t);return e}clearUnusedPartitionForAccount(t,e){let r=new Set;for(let i of this.index.values())this.clearPartition(r,i,e);return r}*getAll(){for(let t of this.list)yield t}*getAllByHostname(t){let e=this.index.get(t);if(e!==void 0)for(let r of e.list)yield r}*getAllFromApp({hostname:t,partitionId:e,accountId:r}){let i=this.index.get(t);if(i===void 0)return;let s=i.map.get(e);if(s===void 0)return;let n=r?s.map.get(r)?.list:s.list;if(n)for(let a of n)yield a}async waitUpdate(){this.updatePromise!==null&&await this.updatePromise}scheduleUpdate(){this.updatePromise===null&&(this.updatePromise=Promise.resolve().then(()=>{this.update().catch(console.error),this.updatePromise=null}).catch(console.error))}async update(){this.onAfterUpdate&&await this.onAfterUpdate()}clearPartition(t,e,r){let i=e.map.get(r);if(!i)return;i.list.forEach(n=>{this.list.delete(n),e.list.delete(n),t.add(n)}),e.map.delete(r)}};l();var St=class{constructor(t,e){this.index=t;this.store=e}optimizePromise=null;queueToRemove=new Set;optimize(t=!1){return this.optimizePromise||(this.optimizePromise=this.internalOptimize(t).finally(()=>{this.optimizePromise=null})),this.optimizePromise}async internalOptimize(t){let e=Date.now()-pe,r=new Map,i=0;for(let n of this.index.getAll()){if(n.getUpdatedAt()<e){this.remove(n);continue}i+=1;let a=n.hostname;r.set(a,(r.get(a)??0)+1)}for(let[n,a]of r){if(a<=Dt)continue;let c=Array.from(this.index.getAllByHostname(n)),p=H(c,u=>A(u.visits));for(let u of p.slice(Dt))i-=1,this.remove(u)}if(i>Bt){let n=Array.from(this.index.getAll()),a=H(n,c=>A(c.visits));for(let c of a.slice(Bt))this.remove(c)}if(t)return;let s=Array.from(this.queueToRemove);this.queueToRemove.clear();for(let n of s)await this.store.removeByKey(n)}remove(t){this.index.remove(t),t.getIDBKeys().forEach(e=>this.queueToRemove.add(e))}};l();l();var et=(o,t,e)=>(ue(o,e.map(r=>r[0]),e.map(r=>r[1])).forEach((r,i)=>{r[t]=i+1}),o);l();function _e(...o){return t=>o.reduce((e,r)=>r(e),t)}l();var Ae=(o,t=(r,i)=>r===i,e)=>{let r=[];o.forEach(s=>{let n=r.findIndex(c=>t(s,c)),a=r[n];if(n===-1){r.push(s);return}!e||e(s)-e(a)>=0||(r[n]=s)});let i=ye(r,t);return me(r,i)||D(new Ft("(non-critical) Found duplicates",{level:"warning"})),i};var Pe=Lt(4e5),Me={lastVisitSecondsAgo:"last_seen_seconds",countVisits:"visits_total",medianTimeBetweenVisitsInSeconds:"median_tbv_seconds_400000",domainRank:"domain_rank",domainVisitUniqueness:"domain_visit_uniqueness",fractionOfVisitsPerDomain:"fraction_of_visits_per_domain",fractionOfVisitsInLastHour:"fraction_of_visits_in_last_3600",rankInLastHour:"rank_in_the_last_3600",fractionOfVisitsInToday:"fraction_of_visits_in_last_86400",rankInToday:"rank_in_the_last_86400",fractionOfVisitsInLast5Days:"fraction_of_visits_in_last_432000",rankInLast5Days:"rank_in_the_last_432000"},Qe=o=>Object.keys(Me).map(e=>o[e]),ze=o=>{if(o.length<=1)return Pe;let t=[];return H(o).forEach((e,r,i)=>{if(r===0)return;let s=i[r-1];h(s!==void 0,"Previous element is nullish",{index:r,arr:i}),t.push(e-s)}),Math.min(tt(H(t),.5),Pe)},$e=(o,t,e)=>Math.max(o,Math.min(t,e)),Ke=(o,t,e=31104e3)=>{if(t===void 0)return e;let r=$e(0,o-t,e);return Math.floor(ot(r))},It=(o,t)=>!o||!t||o<=0?0:o>t?1:o/t,Ge=o=>{let t=Object.values(de(o,"hostname")).map(r=>{let i=Ae(r,(c,p)=>c.getIdForStatistic()===p.getIdForStatistic()),s=i.map(c=>c.getDataForStatistic().visits),n=Z(s,c=>c.length),[a]=i;return h(a,"Failed to compose statistics by domain: uniqItems can not be empty",{items:o}),{hostname:a.hostname,lastVisit:$(s.map(c=>$(c)).filter(z)),countVisits:n,visitUniqueness:i.length/n}}),e=et(t,"rank",[["countVisits","desc"],["lastVisit","desc"]]);return new Map(e.map(r=>[r.hostname,r]))},vt=class{byDomains=new Map;byRecords=new WeakMap;model="";setModel(t){this.model=t}getStatisticsByRecord(t){return this.byRecords.get(t)??null}async process(t){this.byDomains=Ge(t),this.byRecords=this.composeStatisticsByRecords(t),await this.calculateScores(t)}async calculateScores(t){let e=t.map(i=>this.byRecords.get(i)).filter(z),r=this.model?await he({model:this.model,version:4,fields:Object.values(Me),records:e.map(Qe),fetch}):[];e.forEach((i,s)=>{i.score=r[s]??-1})}composeStatisticsByRecords(t){let e=Date.now(),r=t.map(a=>{let{visits:c,attentionSpans:p}=a.getDataForStatistic();return{item:a,lastVisitSecondsAgo:Ke(e,$(c)),medianTimeBetweenVisitsInSeconds:Math.floor(ot(ze(c))),medianAttentionSpanInSeconds:p.length?ot(tt(H(p),.5)):-1,countVisits:c.length,countVisitsInLastHour:M(c,e-zt(1)),countVisitsInToday:M(c,e-C(1)),countVisitsInLast5Days:M(c,e-C(5))}}),i=Z(r,"countVisitsInLastHour"),s=Z(r,"countVisitsInToday"),n=Z(r,"countVisitsInLast5Days");return _e(a=>et(a,"rankInLastHour",[["countVisitsInLastHour","desc"],["lastVisitSecondsAgo","asc"]]),a=>et(a,"rankInToday",[["countVisitsInToday","desc"],["lastVisitSecondsAgo","asc"]]),a=>et(a,"rankInLast5Days",[["countVisitsInLast5Days","desc"],["lastVisitSecondsAgo","asc"]]),a=>a.map(c=>{let p=this.byDomains.get(c.item.hostname);return p?{...c,score:-1,domainRank:p.rank,domainVisitUniqueness:p.visitUniqueness,fractionOfVisitsPerDomain:It(c.countVisits,p.countVisits),fractionOfVisitsInLastHour:It(c.countVisitsInLastHour,i),fractionOfVisitsInToday:It(c.countVisitsInToday,s),fractionOfVisitsInLast5Days:It(c.countVisitsInLast5Days,n)}:(console.error(`Couldn't find statistics for ${c.item.hostname}`),null)}),a=>{let c=new WeakMap;return a.filter(z).forEach(({item:p,...u})=>c.set(p,u)),c})(r)}};var qe=["url","title","favIconUrl","contentTitle","contentFavIconUrl"],xt=class extends j{linker;requestVisits;processStatistic=le(async()=>{await this.statistics.process(Array.from(this.index.getAll()))},$t(2));index=new bt({mergeFn:(t,e)=>{let r=e?e.update(t):new N(t);return this.linker.link(r),r},onAfterUpdate:this.processStatistic});statistics=new vt;indexLoaded=new X;indexReady=new X;store;optimizer;loadPromise=null;batchForSaving=new Set;constructor(t){super(),this.linker=t.linker,this.requestVisits=t.requestVisits??null,this.store=t.store,this.optimizer=new St(this.index,this.store),this.loadPromise=this.loadData().catch(D),this.linker.onReload(()=>this.updatePolishData()),setInterval(()=>{this.saveBatchToIDBStore().catch(D)},Nt(1))}async init(t){this.indexReady.mark(!1),this.loadPromise===null&&(this.loadPromise=this.loadData().catch(D),await this.loadPromise);try{await this.indexLoaded.wait(),await this.importToIndex(t),await this.index.waitUpdate(),await this.processStatistic.flush()}finally{this.loadPromise=null}this.requestVisits&&this.checkVisits()&&this.requestVisitsInternal(),this.indexReady.mark(!0)}async clear(){this.index.clear(),await this.store.clear(),await this.index.waitUpdate(),await this.processStatistic.flush()}upsert(t){let e=this.restoreRecord(t);this.index.upsert(e),this.batchForSaving.add(e)}async removeByUrlList(t){let e=this.index.removeByUrlList(t);await Promise.all(e.map(r=>this.store.remove(r)))}*search(t,e,r,i=t.text?_(t.text):null){let s=S(t)?this.index.getAllFromApp(t):this.index.getAll(),n=S(t)&&this.linker.hasNavigationScriptFor(t.hostname);Object.assign(t,{onlyPolished:n}),yield*this.internalSearch(s,t,e,r,i)}getRecord(t,e,r,i){return this.index.get(t,e,r,i)}getAllRecords(){return this.index.getAll()}getAllHostnames(){return Array.from(this.index.index.values())}getTotalCount(){return this.index.list.size}async recalculateScores(){await this.statistics.calculateScores(Array.from(this.getAllRecords()))}async updateVisits(t){let e=this.getSetOfUrlsWithPartitions();return t.forEach(({url:r,visits:i})=>{e.has(r)||this.upsert({url:r,partitionId:"",visits:i})}),this.saveBatchToIDBStore()}async clearUnusedPartitionForWorkspace(t){let e=this.index.clearUnusedPartitionForWorkspace(t);for(let r of e)await this.store.remove(r)}async clearUnusedPartitionForAccount(t,e){let r=this.index.clearUnusedPartitionForAccount(t,e);for(let i of r)await this.store.remove(i)}saveBatchToIDBStore(){let t=Array.from(this.batchForSaving);return this.batchForSaving.clear(),this.store.upsertMulti(t)}async optimize(){await this.indexLoaded.wait(),await this.optimizer.optimize()}async loadData(){this.indexLoaded.mark(!1),this.index.clear();let t=0;for await(let e of this.store.getAll()){let r=this.index.upsert(e.value);t+=1,r.addIDBKey(e.key),t%1e4===0&&await this.optimizer.optimize(!0)}this.indexLoaded.mark(!0),await this.optimizer.optimize(),await this.store.fixWrongKeys()}updatePolishData(){this.linker.clear();for(let t of this.index.getAll())this.linker.link(t)}restoreRecord(t){let e={...Et,...t};return t.visits&&t.visits.length>0||t.contentCrawledAt?e:{...e,visits:[Date.now()]}}getSetOfUrlsWithPartitions(){let t=new Set;for(let e of this.index.getAll())e.partitionId&&t.add(e.url);return t}getDomainsStatistics(){let t=Date.now(),e=t-q(1),r=t-Y(1);return Object.fromEntries(Array.from(this.index.index.entries()).map(([i,{list:s}])=>{let n=Array.from(s).flatMap(u=>u.visits),a=Number(n.length),c=M(n,r),p=M(n,e);return[i,{all:a,month:c,week:p}]}))}getUrlStatistic(t){let e=Date.now(),r=e-q(1),i=e-Y(1),n=this.getRecord(t.url,t.partitionId,t.hostname)?.visits??[],a=Number(n.length),c=M(n,i),p=M(n,r);return{all:a,month:c,week:p}}getTitleFromUrl(t){let e=ie(t)??"",r=w(st(t))??"",i=R(e),s=R(r);return this.getTitleByUrl(e)??this.getTitleByUrl(r)??this.getTitleByUrl(i)??this.getTitleByUrl(s)}async importToIndex(t){let e=this.getSetOfUrlsWithPartitions();t.forEach(({url:r,title:i,lastVisitTime:s})=>{if(!r||e.has(r)||!O(r))return;let a=s&&Math.floor(s);this.upsert({url:r,partitionId:"",title:i||"",visits:a?[a]:[]})}),await this.saveBatchToIDBStore(),this.compressSameStringsInRecords()}compressSameStringsInRecords(){let t=new Map;qe.forEach(e=>{this.index.list.forEach(r=>{if(!v(r,e))return;let i=r[e];if(typeof i!="string")return;t.has(i)||t.set(i,i);let s=t.get(i)||i;r[e]=s})})}checkVisits(){let t=Array.from(this.index.list).map(r=>r.visits.length).sort((r,i)=>r-i);return tt(t,.95)<=2}requestVisitsInternal(){if(!this.requestVisits)return;let t=Vt(Array.from(this.index.list).filter(e=>!e.partitionId).map(e=>e.url));this.requestVisits(t),this.requestVisits=null}getTitleByUrl(t){return this.getRecord(t,"","")?.export().title??null}};l();var Rt=class{source;constructor(t){this.source=t.source}initOpenedTabs(t){this.source.init(t)}addOpenedTab(t){this.source.add(t)}updateOpenedTab(t){this.source.update(t)}removeOpenedTab(t){this.source.remove(t)}};l();var Tt=class extends j{indexById=new Map;linker;constructor({linker:t}){super(),this.linker=t,this.linker.onReload(()=>this.onLinkerReload())}*search(t,e,r,i=t.text?_(t.text):null){if(S(t))return;let s=this.indexById.values();yield*this.internalSearch(s,t,e,r,i)}init(t){this.clear(),t.forEach(e=>this.add(e))}add(t){let e=new Q(t);this.linker.link(e),this.indexById.set(t.id,e)}update(t){let e=this.indexById.get(t.id);return e===void 0?!1:(e.update(t),this.linker.link(e),!0)}clear(){this.indexById.clear()}remove(t){return this.indexById.get(t)===void 0?!1:(this.indexById.delete(t),!0)}onLinkerReload(){Array.from(this.indexById.values()).forEach(t=>this.linker.link(t))}};l();l();var Be=(o,t)=>{let e={};for(let i=0;i<t.length;i+=1){let s=t[i];h(s,"Cannot export text match: no match with index",{match:t,index:i});let n=e[s.field];(n===void 0||s.score>n.score)&&(e[s.field]={...s,start:0,end:0})}let r=Object.keys(e);for(let i=0;i<r.length;i+=1){let s=r[i];h(s,"Cannot export text match: no field with index",{fields:r,index:i});let n=e[s];h(n,"Cannot export text match: no item for field",{result:e,field:s});let a=o[s];if(typeof a=="string"){let c=a.toLocaleLowerCase().indexOf(n.word);c!==-1&&(e[s]={...n,start:c,end:c+n.query.length})}}return e};l();var De=o=>{if(S(o)||!o.text||o.isOmnibox||!oe(o.text))return null;let t=w(R(o.text));return t?{id:`go-to-${o.text}`,type:"go-to",title:se(t),url:t,hostname:nt(t)??"",partitionId:o.partitionId??"",favIconUrl:F(t),itemType:"Go to",lastVisitTime:0}:null};l();var Oe=o=>{if(S(o)||!o.text||!o.searchExternalSuggest)return null;let{name:t,favicon:e,url:r}=o.searchExternalSuggest;return{id:`search-external-${o.text}`,type:"search-external",title:o.text,url:r.replace("{searchTerms}",encodeURIComponent(o.text)).replace("{inputEncoding}","utf-8").replace("{google:baseURL}","https://google.com/").replace("{yandex:searchPath}","search/").replace(/{[^}]+}/g,""),hostname:nt(r)??"",partitionId:o.partitionId??"",favIconUrl:e,itemType:`Search in ${t}`,lastVisitTime:0}};var kt=class{config;sources;navigationScriptsManager;selectStatistic;requests=new Map;constructor(t){this.config=t.config,this.sources=t.sources,this.navigationScriptsManager=t.navigationScriptsManager,this.selectStatistic=t.selectStatistic}cancelSearch(t){let e=this.requests.get(t);e&&e.abort()}search(t,e){let r=new fe(i=>this.internalSearch(e,()=>Promise.race([new Promise(s=>{setTimeout(s,0)}),i])),()=>{});return this.requests.set(t,r),r.catch(D).finally(()=>{this.requests.delete(t)}),r}async internalSearch(t,e=()=>Promise.resolve()){let{text:r,maxResults:i}=t,s=[],n=r?_(r):null,a=this.getScoringOptions(t),c=this.getExportOptions(t),p=a?this.getScoringComparators():this.getRecentlyUsedComparators(),u=globalThis.performance.now(),m=U=>H(U,p),f=(U,I)=>{for(let G of p){let k=G(I)-G(U);if(k!==0)return k>0}return!1};for(let U of Object.values(this.sources))for(let I of U.search(t,this.config.textMatch,100,n)){for(let k of I)if(k.exported=k.record.export(c),a){k.record.calcScore(k,a)}let G=m(I);for(let k=0,Pt=0;k<i&&Pt<G.length;){let Ht=s[k],rt=G[Pt];if(h(rt!==void 0,"Internal search failed: insert can not be undefined"),!Ht||f(rt,Ht)){let Mt=this.getBestPlace(s,rt,k);Mt!==-1&&(s.splice(Mt,0,rt),Mt===k&&(k+=1)),Pt+=1}else k+=1}globalThis.performance.now()-u>50&&(await e(),u=globalThis.performance.now())}let y=[],T=Math.min(s.length,i);for(let U=0;U<T;U+=1){let I=s[U];h(I?.exported!==void 0,"Internal search failed: current.exported can not be undefined"),I.match&&(I.exported.match=Be(I.exported,I.match)),this.config.debug&&(I.exported.debug=a?I.scoreDebug:new Date(I.exported.lastVisitTime).toUTCString()),y.push(I.exported)}let B=Oe(t),b=De(t)||t.text.endsWith(" ")&&B;return(b||B)&&(y.length===i&&y.splice(y.length-1,1),b?y.unshift(b):B&&y.push(B)),{result:y,meta:{totalHistoryCount:this.sources.history.getTotalCount()}}}getScoringOptions(t){return t.text!==""?{query:t,sources:this.sources,rules:this.config,selectStatistic:this.selectStatistic,now:Date.now()}:null}getExportOptions(t){return{query:t,sources:this.sources,navigationScriptsManager:this.navigationScriptsManager}}getScoringComparators(){return[({score:t})=>(h(t!==void 0,"Score must be type of number to get scoring comparators"),-t)]}getRecentlyUsedComparators(){return[({exported:t})=>Number(t?.itemType==="Web Page"),({exported:t})=>(h(t!==void 0,"Exported must be defined to get recently used comparators"),-t.lastVisitTime)]}getTabId(t){return t.type==="service"||t.type==="tab"?t.tabId:null}isSameResult(t,e){return t===e?!0:t===void 0||e===void 0?!1:t.id===e.id||this.getTabId(t)!==null&&this.getTabId(t)===this.getTabId(e)?!0:t.type==="service"||e.type==="service"?!1:t.url===e.url||t.hostname===e.hostname&&t.title===e.title}sortByBest(t){return t===void 0?1:t.type==="service"?-2:t.type==="tab"?-1:0}getBestPlace(t,e,r){for(let i=0;i<r;i+=1){let s=t[i];if(this.isSameResult(e.exported,s?.exported))return this.sortByBest(e.exported)-this.sortByBest(s?.exported)>=0?-1:i}return r}};l();var P=ge(be.search.params),wt=class{debug=P.debug;app=P.app;openedTab=P.openedTab;bookmark=P.bookmark;document=P.document;other=P.other;textMatch=P.textMatch;update(t){E(this,P,t),this.app=E({},P.app,t.app),this.openedTab=E({},P.openedTab,t.openedTab),this.bookmark=E({},P.bookmark,t.bookmark),this.document=E({},P.document,t.document),this.other=E({},P.other,t.other),this.textMatch=E({},P.textMatch,t.textMatch)}};l();var _t=class{index=new Map;store;constructor(t){this.store=t.store,this.init().catch(console.error)}async init(){this.clear(),(await this.store.getAll()).forEach(({id:e,selects:r})=>this.index.set(e,{id:e,selects:r}))}get(t){let e=this.getRecord(t);return e===null?0:e.selects.length}async select(t){let e=this.getRecord(t),r=e!==null?[...e.selects,Date.now()]:[Date.now()],i={id:t,selects:r};this.index.set(t,i),await this.store.put(t,i)}clear(){this.index.clear()}getRecord(t){return this.index.get(t)??null}};l();var At=class{selectStatistic;historySource;constructor(t){this.selectStatistic=t.selectStatistic,this.historySource=t.historySource}selectSearchItem(t){this.selectStatistic.select(t).catch(D)}async getDomainsStatistic(){return await this.historySource.indexReady.wait(),this.historySource.getDomainsStatistics()}async getUrlStatistic(t){return await this.historySource.indexReady.wait(),this.historySource.getUrlStatistic(t)}};var Ue=()=>{let{searchHistoryMetaStore:o,searchSelectStatStore:t}=Zt(),e=new ne,r=new ft({navigationScriptsManager:e}),i=new wt,s=new _t({store:t}),n,a={apps:new pt,openedTabs:new Tt({linker:r}),bookmarks:new ht({linker:r}),history:new xt({linker:r,store:o,requestVisits:T=>n.getRequestVisitsHandler()(T)})};n=new gt({source:a.history});let c=new dt({source:a.bookmarks}),p=new Rt({source:a.openedTabs}),u=new ct({source:a.apps}),m=new mt({historySource:a.history,historyApi:n,navigationScriptsManager:e}),f=new At({selectStatistic:s,historySource:a.history}),y=new kt({sources:a,selectStatistic:s,config:i,navigationScriptsManager:e});ve({applicationsApi:u,bookmarksApi:c,documentsApi:m,historyApi:n,openedTabsApi:p,searchApi:y,searchConfig:i,statisticApi:f}),Object.assign(globalThis,{sources:a,navigationScriptsManager:e,linker:r,searchConfig:i,searchApi:y})};Ue();var Rn=Wt({api:Ie});
//! `calcScore` mutates `current` here

