function te(t){var e=typeof t;return t!=null&&(e=="object"||e=="function")}var b=te;var re=typeof global=="object"&&global&&global.Object===Object&&global,N=re;var se=typeof self=="object"&&self&&self.Object===Object&&self,ne=N||se||Function("return this")(),h=ne;var oe=function(){return h.Date.now()},T=oe;var ie=/\s/;function ae(t){for(var e=t.length;e--&&ie.test(t.charAt(e)););return e}var j=ae;var ce=/^\s+/;function de(t){return t&&t.slice(0,j(t)+1).replace(ce,"")}var P=de;var ue=h.Symbol,m=ue;var B=Object.prototype,pe=B.hasOwnProperty,le=B.toString,S=m?m.toStringTag:void 0;function me(t){var e=pe.call(t,S),r=t[S];try{t[S]=void 0;var s=!0}catch{}var n=le.call(t);return s&&(e?t[S]=r:delete t[S]),n}var D=me;var ge=Object.prototype,fe=ge.toString;function ye(t){return fe.call(t)}var F=ye;var be="[object Null]",Se="[object Undefined]",k=m?m.toStringTag:void 0;function Ee(t){return t==null?t===void 0?Se:be:k&&k in Object(t)?D(t):F(t)}var L=Ee;function Me(t){return t!=null&&typeof t=="object"}var $=Me;var he="[object Symbol]";function Te(t){return typeof t=="symbol"||$(t)&&L(t)==he}var H=Te;var G=0/0,Ce=/^[-+]0x[0-9a-f]+$/i,Re=/^0b[01]+$/i,xe=/^0o[0-7]+$/i,ve=parseInt;function Oe(t){if(typeof t=="number")return t;if(H(t))return G;if(b(t)){var e=typeof t.valueOf=="function"?t.valueOf():t;t=b(e)?e+"":e}if(typeof t!="string")return t===0?t:+t;t=P(t);var r=Re.test(t);return r||xe.test(t)?ve(t.slice(2),r?2:8):Ce.test(t)?G:+t}var U=Oe;var Ae="Expected a function",Ue=Math.max,_e=Math.min;function we(t,e,r){var s,n,o,i,a,d,u=0,l=!1,f=!1,v=!0;if(typeof t!="function")throw new TypeError(Ae);e=U(e)||0,b(r)&&(l=!!r.leading,f="maxWait"in r,o=f?Ue(U(r.maxWait)||0,e):o,v="trailing"in r?!!r.trailing:v);function O(c){var p=s,y=n;return s=n=void 0,u=c,i=t.apply(y,p),i}function X(c){return u=c,a=setTimeout(M,e),l?O(c):i}function z(c){var p=c-d,y=c-u,I=e-p;return f?_e(I,o-y):I}function _(c){var p=c-d,y=c-u;return d===void 0||p>=e||p<0||f&&y>=o}function M(){var c=T();if(_(c))return w(c);a=setTimeout(M,z(c))}function w(c){return a=void 0,v&&s?O(c):(s=n=void 0,i)}function Z(){a!==void 0&&clearTimeout(a),u=0,s=d=n=a=void 0}function ee(){return a===void 0?i:w(T())}function A(){var c=T(),p=_(c);if(s=arguments,n=this,d=c,p){if(a===void 0)return X(d);if(f)return clearTimeout(a),a=setTimeout(M,e),O(d)}return a===void 0&&(a=setTimeout(M,e)),i}return A.cancel=Z,A.flush=ee,A}var W=we;var E=(t,e,r=!0)=>r?Object.prototype.hasOwnProperty.call(t,e):e in t;var g=class extends Error{context;constructor(e,r={}){super(e),this.name="DetailedError",this.context=r,E(Error,"captureStackTrace")&&typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,this.constructor)}};var C=class extends g{constructor(e){super(e,{isSilent:!0}),this.name="AbortError"}};var Q=null;var V=(t,e=void 0)=>{console.error(t),Q&&Q.captureException(t,e)};var R=t=>{t instanceof Promise&&t.catch(V)};var q=t=>t.type==="FOCUS_MODE";var J=t=>t.type==="SEND_ANALYTICS";var Y=t=>t.type==="CALL_CUSTOM_SUBSCRIBER";var x=class extends g{constructor(e,r,s){super(`[${e}]: ${r}`,{extra:s,tags:{recipeId:e}}),this.name="RecipeError"}};var Ie=t=>{let s=0,n,o=async()=>{try{s++,await t(),clearInterval(n)}catch(i){if(s>5)throw clearInterval(n),i}};n=window.setInterval(()=>{o().catch(console.error)},500)},K=class{constructor(e,r){this.api=e;this.recipeId=r;Object.getOwnPropertyNames(Object.getPrototypeOf(this)).forEach(s=>{this[s]instanceof Function&&s!=="constructor"&&(this[s]=this[s].bind(this))}),this.subscriptions.add(this.api.onMessage(s=>{q(s)&&(this.focusModeState=s.payload,this.focusModeSubscribers.forEach(n=>R(n(this.focusModeState))))})),this.api.onUnload(()=>{this.unloaded||this.unload()})}currentBadgeValue;focusModeState=null;focusModeSubscribers=new Set;unloaded=!1;unloadSubscribers=new Set;subscriptions=new Set;assert(e,r="Assertion failed",{extra:s,clearBadges:n}={}){if(e)return;let o=new x(this.recipeId,r,s),i={type:"SEND_ERROR",error:{message:o.message,name:o.name,context:o.context,stack:o.stack}};throw n&&this.setBadge(0),this.api.sendMessage(i),o}addCustomSubscriber(e,r){let s={type:"SET_CUSTOM_SUBSCRIBER",name:e};this.api.sendMessage(s),this.unloadSubscribers.add(this.api.onMessage(n=>{!Y(n)||n.name!==e||R(r(...n.args??[]))}))}callSubscribers(e,...r){let s={type:"CALL_CUSTOM_SUBSCRIBER",name:e,args:r};this.api.sendMessage(s)}injectToFrames(){this.api.sendMessage({type:"INJECT_FRAMES_REQUEST"})}assertSelectorResult(e,r){this.assert(e,r?`Missing selector: ${r}`:void 0)}expectSelector(e,r,s,n=`${r}: ${s}`){let o=e.querySelector(s);return this.assertSelectorResult(o,n),o}expectSelectorAll(e,r,s,n){let o=typeof s=="string"?s:s.join(", "),i=e.querySelectorAll(o);return this.assertSelectorResult(i.length,n??`${r}: ${o}`),Array.from(i)}observe(e,r,s={}){let n=()=>Ie(r),o=s.debounceMs?W(n,s.debounceMs):n,i=new MutationObserver(u=>{u.some(l=>l.target instanceof HTMLElement&&l.target.matches?.(e)||l.target.parentElement?.matches(e))&&o()}),a={attributes:!0,childList:!0,subtree:!0,characterData:!0};i.observe(document,a),n();let d=()=>i.disconnect();return this.api.onUnload(d),d}isLocalStorageItemExist(e){return E(localStorage,e)}isCookieExist(e){let r=`^(.*;)?\\s*${e}\\s*=\\s*[^;]+(.*)?$`;return new RegExp(r).test(document.cookie)}waitMS(e){return new Promise(r=>{setTimeout(r,e)})}waitDocReady(){return new Promise(e=>{if(document.readyState!=="loading"){e();return}let r=()=>{document.removeEventListener("DOMContentLoaded",r),e()};document.addEventListener("DOMContentLoaded",r)})}waitUntilElementExist(e,r,s){return new Promise((n,o)=>{let i=()=>{let d=Array.isArray(r)?r.join(", "):r.toString(),u=(e instanceof HTMLElement||e instanceof Document)&&e.querySelector(d);return u&&n(u),Boolean(u)};if(i())return;let a=new MutationObserver(d=>d.forEach(u=>{u.addedNodes&&i()&&a.disconnect()}));this.api.onUnload(()=>{a.disconnect(),o(new C("Script Api is unloaded"))}),s&&setTimeout(()=>{a.disconnect(),n(void 0)},s),a.observe(document.body,{childList:!0,subtree:!0,attributes:!1,characterData:!1})})}async waitPageWillBeHidden(){return this.waitPageVisibleState("hidden")}async waitPageWillBeVisible(){return this.waitPageVisibleState("visible")}putResource(e,{title:r="",favIconUrl:s}){if(this.api.isUnloaded)return;let n={type:"PUT_RESOURCE",url:e,title:r,favIconUrl:s};this.api.sendMessage(n)}setBadge(e){if(this.api.isUnloaded||this.currentBadgeValue&&this.currentBadgeValue===e)return;this.currentBadgeValue=e;let r={type:"BADGES",value:e};this.api.sendMessage(r)}setAccounts(e){if(this.api.isUnloaded)return;let r={type:"ACCOUNTS",accounts:e};this.api.sendMessage(r)}subscribeFocusMode(e){return this.focusModeState!==null?R(e(this.focusModeState)):this.api.sendMessage({type:"REQUEST_FOCUS_MODE_STATE"}),this.focusModeSubscribers.add(e),()=>{this.focusModeSubscribers.delete(e)}}triggerAnalyticEvent(e,r){let s={type:"SEND_ANALYTICS",name:e,payload:r};J(s),this.api.sendMessage(s)}unload(){this.unloaded=!0,this.focusModeSubscribers.clear(),this.subscriptions.forEach(e=>e()),this.subscriptions.clear(),this.unloadSubscribers.forEach(e=>e()),this.unloadSubscribers.clear()}async waitPageVisibleState(e){return document.visibilityState===e?Promise.resolve():new Promise(r=>{let s=()=>{document.visibilityState===e&&(document.removeEventListener("visibilitychange",s,!1),r())};document.addEventListener("visibilitychange",s,!1)})}};export{K as RecipeScriptApi};

